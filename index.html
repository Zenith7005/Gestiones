<script>
// URL del Web App de Google Apps Script
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw9f3EXGNfXMDUvxuNtevcNCl23QURpBCRAu8hVfw42SZxB8HBrQLMJSGrWOJ4OcbRJaA/exec";

// Array para guardar los registros en memoria (para la tabla y estadísticas locales)
const registros = [];

// Mascara de fecha dd/mm/aaaa con barras automáticas
function configurarMascaraFecha(id) {
    const input = document.getElementById(id);
    input.setAttribute('maxlength', '10');

    input.addEventListener('input', function () {
        // Solo números
        let v = this.value.replace(/[^\d]/g, '');
        if (v.length > 8) v = v.slice(0, 8);

        if (v.length >= 5) {
            this.value = v.slice(0, 2) + '/' + v.slice(2, 4) + '/' + v.slice(4);
        } else if (v.length >= 3) {
            this.value = v.slice(0, 2) + '/' + v.slice(2);
        } else {
            this.value = v;
        }
    });
}

// Campo numérico con longitud máxima
function configurarCampoNumerico(id, maxLen) {
    const input = document.getElementById(id);
    input.setAttribute('maxlength', String(maxLen));

    input.addEventListener('input', function () {
        // Solo números y tope de longitud
        this.value = this.value.replace(/\D/g, '').slice(0, maxLen);
    });
}

// Obtener ámbitos seleccionados
function obtenerAmbitosSeleccionados() {
    const checks = document.querySelectorAll('.ambito:checked');
    const valores = Array.from(checks).map(c => c.value);
    return valores;
}

// Cargar registros desde Google Sheets al iniciar
function cargarRegistrosDesdeServidor() {
    fetch(SCRIPT_URL)
        .then(res => res.json())
        .then(data => {
            // data es un array de objetos con: gestion, fecha, nombre, dni, tipo, ambitos
            const tabla = document
                .getElementById("tabla")
                .getElementsByTagName("tbody")[0];

            data.forEach(reg => {
                registros.push(reg);

                const fila = tabla.insertRow();
                fila.insertCell(0).innerText = reg.gestion;
                fila.insertCell(1).innerText = reg.fecha;
                fila.insertCell(2).innerText = reg.nombre;
                fila.insertCell(3).innerText = reg.dni;
                fila.insertCell(4).innerText = reg.tipo;
                const amb = Array.isArray(reg.ambitos) ? reg.ambitos.join(", ") : reg.ambitos;
                fila.insertCell(5).innerText = amb || "";
            });
        })
        .catch(err => {
            console.error("Error cargando registros desde el servidor:", err);
        });
}

document.addEventListener('DOMContentLoaded', () => {
    configurarMascaraFecha('fecha');
    configurarMascaraFecha('fechaDesde');
    configurarMascaraFecha('fechaHasta');

    configurarCampoNumerico('gestion', 5);
    configurarCampoNumerico('dni', 8);

    // NUEVO: al cargar la página, traemos lo que ya estaba en la planilla
    cargarRegistrosDesdeServidor();
});

function agregarRegistro() {
    const gestion = document.getElementById("gestion").value.trim();
    const fecha = document.getElementById("fecha").value.trim();
    const nombre = document.getElementById("nombre").value.trim();
    const dni = document.getElementById("dni").value.trim();
    const tipo = document.getElementById("tipo").value;
    const ambitos = obtenerAmbitosSeleccionados();

    if (!gestion || !fecha || !nombre || !dni) {
        alert("Por favor completá todos los campos obligatorios.");
        return;
    }

    if (gestion.length !== 5) {
        alert("El número de gestión debe tener exactamente 5 dígitos.");
        return;
    }

    if (dni.length !== 8) {
        alert("El DNI debe tener exactamente 8 dígitos.");
        return;
    }

    if (!parseFecha(fecha)) {
        alert("La fecha de la gestión no es válida. Usá el formato dd/mm/aaaa.");
        return;
    }

    // Agregar fila a la tabla (vista local)
    const tabla = document
        .getElementById("tabla")
        .getElementsByTagName("tbody")[0];

    const fila = tabla.insertRow();

    fila.insertCell(0).innerText = gestion;
    fila.insertCell(1).innerText = fecha;
    fila.insertCell(2).innerText = nombre;
    fila.insertCell(3).innerText = dni;
    fila.insertCell(4).innerText = tipo;
    fila.insertCell(5).innerText = ambitos.join(", ");

    // Guardar registro en el arreglo local (para estadísticas)
    const registro = { gestion, fecha, nombre, dni, tipo, ambitos };
    registros.push(registro);

    // Enviar registro a Google Sheets
    enviarAGoogleSheets(registro);

    // Limpiar formulario
    document.getElementById("formulario").reset();
}

// Enviar datos al Web App de Google Apps Script
function enviarAGoogleSheets(registro) {
    console.log("Enviando registro a Google Sheets:", registro);
    fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors', // enviamos sin esperar respuesta
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(registro)
    }).catch(err => {
        console.error('Error al enviar a Google Sheets:', err);
        alert("Hubo un problema enviando los datos a la hoja. Revisá la consola.");
    });
}

// Parsear fecha dd/mm/aaaa a objeto Date
function parseFecha(cadena) {
    if (!cadena) return null;
    const partes = cadena.split("/");
    if (partes.length !== 3) return null;

    const dia = parseInt(partes[0], 10);
    const mes = parseInt(partes[1], 10) - 1; // Mes empieza en 0
    const anio = parseInt(partes[2], 10);

    if (isNaN(dia) || isNaN(mes) || isNaN(anio)) return null;

    const fecha = new Date(anio, mes, dia);
    if (isNaN(fecha.getTime())) return null;

    // Chequeo simple de coherencia
    if (fecha.getDate() !== dia || fecha.getMonth() !== mes || fecha.getFullYear() !== anio) {
        return null;
    }

    return fecha;
}

function calcularEstadisticas() {
    const desdeStr = document.getElementById("fechaDesde").value.trim();
    const hastaStr = document.getElementById("fechaHasta").value.trim();

    const desde = parseFecha(desdeStr);
    const hasta = parseFecha(hastaStr);

    if (!desde || !hasta) {
        alert("Revisá el formato de las fechas (deben ser dd/mm/aaaa).");
        return;
    }

    // Normalizar rangos (comienzo y fin del día)
    desde.setHours(0, 0, 0, 0);
    hasta.setHours(23, 59, 59, 999);

    let total = 0;
    let casoNuevo = 0;
    let seguimiento = 0;

    registros.forEach(reg => {
        const fechaReg = parseFecha(reg.fecha);
        if (!fechaReg) return;

        if (fechaReg >= desde && fechaReg <= hasta) {
            total++;
            if (reg.tipo === "Caso Nuevo") casoNuevo++;
            if (reg.tipo === "Seguimiento") seguimiento++;
        }
    });

    const resultadoDiv = document.getElementById("resultadoStats");

    resultadoDiv.innerHTML = `
        <p><strong>Resultados entre ${desdeStr} y ${hastaStr}</strong></p>
        <ul>
            <li>Total de registros: ${total}</li>
            <li>Caso Nuevo: ${casoNuevo}</li>
            <li>Seguimiento: ${seguimiento}</li>
        </ul>
    `;
}
</script>
